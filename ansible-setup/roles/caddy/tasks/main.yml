---
- name: Install Caddy
  ansible.builtin.package:
    name: caddy
    state: present

- name: Enable Caddy service
  ansible.builtin.service:
    name: caddy
    enabled: true

- name: Start Caddy service
  ansible.builtin.service:
    name: caddy
    state: started

- name: Deploy Caddyfile
  ansible.builtin.copy:
    dest: /etc/caddy/Caddyfile
    mode: "0644"
    content: |
      {{ caddy_domain }} {
          reverse_proxy localhost:5678 {
              transport http {
                  read_timeout 3600s
                  write_timeout 3600s
              }
          }

          encode gzip

          header {
              X-Frame-Options "DENY"
              X-XSS-Protection "1; mode=block"
              Referrer-Policy "strict-origin-when-cross-origin"
              Permissions-Policy "geolocation=(), microphone=(), camera=()"
          }
      }
  notify: Reload Caddy
